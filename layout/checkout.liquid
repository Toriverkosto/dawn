<!DOCTYPE html>
<html lang="{{ locale }}" dir="{{ direction }}" class="{{ checkout_html_classes }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, user-scalable=0">
    <meta name="referrer" content="origin">

    <title>{{ page_title }}</title>

    {{ content_for_header }}

    {{ checkout_stylesheets }}
    {{ checkout_scripts }}

    <!-- Google Tag Manager -->
    <script>
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
              j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
              'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-WB6W9KG');
    </script>
    <!-- End Google Tag Manager -->
    {% if first_time_accessed %}
      <script>
        // TODO: Maybe needed?
        // gtag('config', 'AW-868520289', {'allow_enhanced_conversions': true});
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}

        function discount(){
          return (Shopify.checkout.discount == null) ? 0 : Shopify.checkout.discount.amount;
        }

        function items(){
          var jsonarray = [];
          for (var line_item_count = 0; line_item_count < Shopify.checkout.line_items.length; line_item_count++){
            jsonarray.push({
              item_id: {% if product_id == "product_id_variant-id" %}'{{ product_id_prefix }}' + Shopify.checkout.line_items[line_item_count].product_id + '_' + Shopify.checkout.line_items[line_item_count].variant_id{% elsif product_id == 'variant-id' %}Shopify.checkout.line_items[line_item_count].variant_id{% elsif product_id == 'sku' %}Shopify.checkout.line_items[line_item_count].sku{% endif %},
              quantity: Shopify.checkout.line_items[line_item_count].quantity,
              price: Shopify.checkout.line_items[line_item_count].line_price
            })
          }
          return jsonarray;
        }

        var enhanced_conversion_data = {
          {% unless checkout.email == blank %}"email": "{{ checkout.email }}",{% endunless %}
          {% unless billing_address.phone == blank %}"phone_number": "{{ billing_address.phone }}",{% endunless %}
          {% unless billing_address.first_name == blank %}"first_name": "{{ billing_address.first_name }}",{% endunless %}
          {% unless billing_address.last_name == blank %}"last_name": "{{ billing_address.last_name }}",{% endunless %}
          // TODO: Try better at finding name and address
          "address": {
            {% unless billing_address.street == blank %}"street": "{{ billing_address.street }}",{% endunless %}
            {% unless billing_address.city == blank %}"city": "{{ billing_address.city }}",{% endunless %}
            {% unless billing_address.province_code == blank %}"region": "{{ billing_address.province_code }}",{% endunless %}
            {% unless billing_address.zip == blank %}"postal_code": "{{ billing_address.zip }}",{% endunless %}
            {% unless billing_address.country_code == blank %}"country": "{{ billing_address.country_code }}"{% endunless %}
          }
        };

        gtm({enhanced_conversion_data: enhanced_conversion_data});

        gtm('event', 'purchase', {
          currency: Shopify.checkout.total_price_set.presentment_money.currency_code,
          transaction_id: '{{ order.order_number }}',
          value: Shopify.checkout.total_price_set.presentment_money.amount,
          discount: discount(),
          coupon: Shopify.checkout.discount.code,
          shipping: Shopify.checkout.shipping_rate.price,
          tax: Shopify.checkout.total_tax,
          items: Shopify.checkout.line_items.map(item => ({
            item_id: item.sku,
            item_name: item.title,
            item_brand: item.vendor,
            price: item.price,
            quantity: item.quantity,
          }))
        });

        console.log(`DATALAYER?`, JSON.stringify(window.dataLayer, null, 4));
      </script>
    {% endif %}
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WB6W9KG"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    {{ skip_to_content_link }}

    <header class="banner" data-header role="banner">
      <div class="wrap">
        {{ content_for_logo }}
      </div>
    </header>

    {{ order_summary_toggle }}
    <div class="content" data-content>
      <div class="wrap">
        <div class="main">
          <header class="main__header" role="banner">
            {{ content_for_logo }}
            {{ breadcrumb }}
            {{ alternative_payment_methods }}
          </header>
          <main class="main__content" role="main">
            {{ content_for_layout }}
          </main>
          <footer class="main__footer" role="contentinfo">
            {{ content_for_footer }}
          </footer>
        </div>
        <aside class="sidebar" role="complementary">
          <div class="sidebar__header">
            {{ content_for_logo }}
          </div>
          <div class="sidebar__content">
            {{ content_for_order_summary }}
          </div>
        </aside>
      </div>
    </div>

    {{ tracking_code }}
  </body>
</html>
